LPTabState=function(){var e={},t=null;LPPlatform.onTabClosed(function(t){delete e[t]}),Topics.get(Topics.CLEAR_DATA).subscribe(function(){e={}});var s=function(e){this.tabID=e.tabID,this.domain=lp_gettld_url(e.tabURL),this.sites=[],this.acccountsVersion=null,this.usernameField=null,this.username=null};s.prototype.getSites=function(){if(this.acccountsVersion!==g_local_accts_version){this.sites=[];var e=getsites(this.domain);for(var t in e)this.sites.push(g_sites[t]);this.acccountsVersion=g_local_accts_version}return this.passwordForm?reorderOnURL(getsites(this.domain),this.passwordForm.getURL()):this.sites},s.prototype.getFields=function(){var e=[];this.passwordForm&&(e=this.passwordForm.getFields());var t=this.getUsernameField();t&&t.value===this.getUsername()&&(0===e.filter(function(e){return e.name===t.name&&e.value===t.value}).length&&e.unshift(t));return e.filter(function(e){return e.id||e.attributes.name})},s.prototype.getUsernameField=function(){if(!this.usernameField)for(var t in e){var s=e[t];if(s.usernameField&&compare_tlds(s.domain,this.domain)){this.usernameField=s.usernameField;break}}return this.usernameField},s.prototype.setUsernameField=function(e){e&&(this.usernameField=e)},s.prototype.setUsername=function(e){e&&(this.username=e)},s.prototype.getUsername=function(){if(!this.username&&this.passwordForm&&(this.username=this.passwordForm.getUsername()),!this.username)for(var t in e){var s=e[t];if(s.username&&compare_tlds(s.domain,this.domain)){this.username=s.username;break}}return this.username};s.prototype.processPasswordSubmit=function(e,t){this.passwordForm=new LPFormParser.FormParser(this,e),this.setUsernameField(this.passwordForm.getUsernameField()),this.setUsername(this.passwordForm.getUsername()),e.generatedPassword?this.generatedPassword=e.generatedPassword:LPPlatform.once(LPPlatform.onTransition,function(e){(function(e,t){switch(t.transitionType){case"auto_subframe":case"manual_subframe":return!1}return t.transitionQualifiers.indexOf("from_address_bar")>-1||t.transitionQualifiers.indexOf("forward_back")>-1})(0,e)&&this.clear()},this)},s.prototype.processTextSubmit=function(e,t){var s=new LPFormParser.FormParser(this,e,{strict:!0});this.setUsernameField(s.getUsernameField()),this.setUsername(s.getUsername())},s.prototype.getMatchingSites=function(){var e=this,t=e.getSites();if(e.getUsername())t=t.filter(function(t){return LPUtils.SiteParser.hasMatchingSiteUserName(t,e.getUsername())});else{var s=e.passwordForm&&e.passwordForm.getOriginalPassword();s&&(t=t.filter(function(e){return null!==LPUtils.SiteParser.findMatchingSitePassword(e,s)})),0===t.length&&(t=e.getSites())}return t},s.prototype.shouldShowSiteNotification=function(){if(this.passwordForm&&this.passwordForm.succeeded())return this.passwordForm.isChangePasswordForm()?Preferences.get("showChangeNotificationBar"):Preferences.get("showSaveNotificationBar")};var r=function(e,t){if(t.length>0){e.fields=e.fields.concat(t),g_local_accts_version++,rewritelocalfile();var s={data:(r=t,a="",r.forEach(function(e){a+=e.formname+"\t"+encodeURIComponent(e.name)+"\t"+encodeURIComponent(crypto_btoa(e.value))+"\t"+encodeURIComponent(e.type)+"\n"}),bin2hex(a)),ref:url2hex(e.url),updatefields:1,aid:e.aid};e.sharedfolderid&&(s.sharedfolderid=e.sharedfolderid),e.postdata=new PostParams(s).toString(),e.posturl=base_url+"gm_deliver.php",e.newvalues=t,updateFieldsFromSubmit(e.postdata,e)}var r,a},a=function(e){return{name:e.attributes.name||e.id,type:e.type,value:e.value,formname:""}};s.prototype.addFields=function(e){if(this.getUsername()){var t=this.getFields();e.forEach(function(e){if(e.fields){var s=[];t.forEach(function(t){var r,i,o=a(t);0===e.fields.filter(function(s){return s.name===o.name&&(!e.save_all||s.formname===t.formname)}).length&&s.push({otherfield:e.save_all,name:o.name,type:o.type,value:(r=e,i=t.value,i===r.unencryptedUsername?r.username:i===LPUtils.decrypt(r,r.password)?r.password:lpmenc_acct(i,!0,r,g_shares)),checked:!1,formname:e.save_all?t.formname:"",urid:"0",otherlogin:"0",url:""})}),r(e,s)}})}},s.prototype.getSiteNotificationData=function(e){if(this.passwordForm){var t={formSubmitted:this.passwordForm.submitted(),formSucceeded:this.passwordForm.succeeded()};if(this.shouldShowSiteNotification()){var s=this.passwordForm.getFormData(),r=this.getMatchingSites(),i=r.filter(function(e){return null!==LPUtils.SiteParser.findMatchingSitePassword(e,this.passwordForm.getPassword())},this);if(i.length>0)return this.addFields(i),this.clear({force:!0}),{};t.matchingSites=r.map(function(e){return e.aid});var o="";g_nofolder_feature_enabled||(o=siteCats[this.domain]||"");var n=getacct(get_personal_linked());if(Policies.getAccountSelectionBasedOnEmail()&&n&&this.username===n.group&&(o=n.group+"\\"+o),t.defaultData={url:this.passwordForm.shouldSaveFields()?s.url:hostof(s.url),name:this.domain,unencryptedUsername:this.getUsername(),group:o,basic_auth:this.passwordForm.isBasicAuthentication()?"1":"0",realm:s.realm,domain:lp_gettld_url(e.tabURL),domainSites:this.getSites().length},t.dialogData={password:this.passwordForm.getPassword()},t.matchingSiteSameSubDomain=1===r.length&&hostof(r[0].url)===hostof(this.passwordForm.getFormData().url),t.sameDomain=compare_tlds(lp_gettld_url(this.passwordForm.getFormData().url),lp_gettld_url(e.tabURL)),t.generatedPassword=this.generatedPassword===this.passwordForm.getPassword(),t.ezpass_test=LPContentScriptFeatures.ezpass_test,this.passwordForm.shouldSaveFields())this.getFields().length>0&&(t.dialogData.fields=this.getFields().map(a))}else this.clear();return t}return{}},s.prototype.getFormSubmissionTabState=function(){for(var e=this;e;){if(e.passwordForm)return e;e=e.previousTabState}return this},s.prototype.getUsernames=function(){return this.getSites().map(function(e){return e.unencryptedUsername})},s.prototype.getSiteNotification=function(e,t){if(e.callback){var s=this.getFormSubmissionTabState(),r=function(){e.callback(s.getSiteNotificationData(t))};if(s.passwordForm&&s.passwordForm.getPassword()){if(s.domain===this.domain&&!s.passwordForm.isBasicAuthentication())return void function(e,t,s){var r=!1,a=LPTabs.get({tabID:e.tabID}),i=function(){if(e.passwordForm&&(e.passwordForm.succeeded()||e.passwordForm.succeeded(!r),e.passwordForm.succeeded()&&!e.passwordForm.getUsername()&&e.getSites().length>0))return i=a,o=s,n=(t=e).getUsernames(),void i.forEachWindow({each:function(e,s){return e.LPContentScriptTools.findText({searches:n,callback:function(e){t.setUsername(e),s()}})},done:o});var t,i,o,n;s()};if(t){var o=a.getFrame(t.frameID);o&&o.LPSiteNotification.formExists(e.passwordForm.getFormData(),function(e){r=e,i()})}else e.passwordForm.getFormData().top?a.getTop().LPSiteNotification.formExists(e.passwordForm.getFormData(),function(e){r=e,i()}):a.onFramesLoaded(function(){a.forEachFrame({each:function(t,s){return t.LPSiteNotification.formExists(e.passwordForm.getFormData(),function(e){r=r||e,s()})},done:i})})}(s,e.source,r);s.passwordForm.succeeded(!0)}r()}},s.prototype.clear=function(e){var t=e&&e.force,s=!0;return this.previousTabState&&(s=this.previousTabState.clear(e))&&delete this.previousTabState,this.passwordForm&&(this.passwordForm.getPassword()===this.generatedPassword&&(this.passwordForm.submitted(!1),s=!1),(s||t)&&(delete this.passwordForm,delete this.generatedPassword)),s},s.prototype.processBasicAuthentication=function(e){this.passwordForm=new LPFormParser.FormParser(this,{basicAuthentication:!0,url:e.url,realm:e.realm,username:e.username,password:e.password})};var i=function(e){if(!lploggedin)return!1;var t=lp_gettld_url(e.tabURL);if(LPContentScriptFeatures.new_save_site)return!hasNeverSave(e.tabURL,t)&&!lp_url_is_lastpass(e.tabURL)&&!lp_url_is_lastpassext(e.tabURL);var s=IntroTutorial.getState();return s.enabled&&s.domain===t},o=function(t,r){if(t){if(i(t)){var a=e[t.tabID];if(!a||!compare_tlds(a.domain,lp_gettld_url(t.tabURL))){var n=e[t.tabID]=new s(t);n.previousTabState=a,a=n}r(a)}}else LPPlatform.getCurrentTab(function(e){e&&o(e.tabDetails,r)})};return{getSiteNotification:function(e,t){o(t,function(s){s.getSiteNotification(e,t)})},clear:function(e,t){o(t,function(t){t.clear(e)})},processPasswordSubmit:function(e,t){o(t,function(s){s.processPasswordSubmit(e.formData,t),s.getSiteNotification({callback:e.callback,source:t},t)})},processTextSubmit:function(e,t){o(t,function(s){s.processTextSubmit(e,t)})},processBasicAuthentication:function(e,t){o(t,function(t){t.processBasicAuthentication(e)})},getState:function(e,t){var s={enabled:i(t)};s.enabled?o(t,function(t){s.usernames=t.getUsernames(),s.formSubmittedFrame=t.passwordForm&&!t.passwordForm.getFormData().top,e(s)}):e(s)},setCopiedGeneratedPassword:function(e){t=e},getCopiedGeneratedPassword:function(e){e(t)}}}();
//# sourceMappingURL=sourcemaps/loginTracking.js.map
